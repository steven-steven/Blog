<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Invoice App V2</title>
    <link rel="stylesheet" href="/assets/tailwind-411f91dd5b89fb0c5835c0d0f1189f0def25c96cd270c454ec884aba7c991825.css" media="screen" />
    <script src="/assets/build/application-4230f8bd593d59f5f3586a39eb8353a548c37479bd50792836be84edda12f04c.js"></script>
  </head>
  <body class="bg-gray-100 dark:bg-slate-900 text-slate-900 dark:text-slate-300 text-sm md:text-base">
    <div class="flex flex-col md:flex-row items-center gap-5 justify-between mx-32 mt-10 md:mt-20">
  <a class="text-3xl font-serif font-light" href="/">Steven</a>
  <nav class="flex gap-x-6 items-center">
    <button data-controller="dark-toggle" data-action="dark-toggle#toggle dblclick->dark-toggle#resetSystemMode" type="button" class="inline-block align-middle nav-link">
  <svg data-dark-toggle-target="dark" class="hidden w-6 h-6 text-slate-700" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
  <svg data-dark-toggle-target="light" class="w-6 h-6 text-slate-200" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
</button>
      <a href="/blog">Blog</a>
      <a href="/works">Works</a>
  </nav>
</div>
    
  <div class="max-w-[46rem] md:mx-auto flex flex-col gap-y-10 md:gap-y-20 px-6 md:px-11 leading-relaxed font-serif">
    <div>
      
  <header class="pt-12 md:pt-16">
    <h1 class="text-2xl md:text-3xl font-bold">Building Invoice App V2</h1>
      <p class="opacity-70">Wednesday,  December 30 2020<p>
  </header>
  <main class="prose dark:prose-invert max-w-none mt-6 text-inherit text-base md:text-lg break-words prose-code:before:hidden prose-code:after:hidden prose-code:p-1 prose-code:rounded-md prose-code:font-medium prose-code:bg-gray-300 dark:prose-code:bg-slate-700">
    <p>Recently, I had a major update on <a href="/blog/creating-an-invoice-app-with-electron-and-go" target="_blank">the invoice app I made 5 months ago</a>.</p>

<p>Briefly recapping this side project, I&rsquo;m creating a custom invoicing native Electron application. The users (employees) enter in the inventory items or the invoice data, which would then call a backend server written in Go, before submitting it on Firebase DB. The invoice PDF can be printed client-side on the electron app.</p>

<p>For the new changes, I thought I&rsquo;d make a blog entry simply for my own documentation purposes. I think the problems I had are pretty open ended, and there are probably solutions I didn&rsquo;t quite think through so I&rsquo;m all ears for suggestions.</p>

<p>Here&rsquo;s a breakdown for the newly added requirements:</p>

<ol>
<li>Offline Capability (essential)

<ul>
<li>Rationale: The office is located in a rural geographical area. Occasionally, internet connection is unreliable. Thus, the client feels offline capabilities are a major functional requirement (more than their need to sync data online).</li>
<li>My thoughts: Removing online means getting rid of the server and DB on the cloud and store data locally. Although this reduces the technical complexity, I think it limits the potential to scale the app in the future (ie. multiple devices can use the app in parallel). Online also adds the benefit of auto-backup in case local data is accidentally erased. A hybrid (supports offline and online) would be ideal although this means a more complex logic to maintain fault tolerance.</li>
</ul></li>
<li>Generate a PDF receipt document (essential)

<ul>
<li>Rationale: The invoice is essentially a quote for the client&rsquo;s purchased services. After we receive the payment, we want to print another type of document as a receipt for them to keep.</li>
<li>My thoughts: should be easy since it&rsquo;s the same logic as invoice generator. Just need to make another template.</li>
</ul></li>
<li>Users might want to manually edit the Invoice ID (non-essential)

<ul>
<li>A bit of background: IDs are currently formatted as &lsquo;YYMM-[incrementing count that resets every year]&rsquo; and is unique. Every time a new invoice is created, I check the last count in the DB and increment it.</li>
<li>My thoughts on a non unique id on the DB: Aside from &lsquo;a nice to have&rsquo;, if we were to enable hybrid (online and offline) then the invoice ID can&rsquo;t be unique either way since inconsistency could occur between the counter on local cache and the server. Therefore, all invoice needs another id that can be generated either locally or on the server and remain unique on the DB. Well, UUID is the perfect solution for that.</li>
<li>My thoughts on enabling manual edit: the incrementing count should be stored on local disk. Users can change them, and the count will by default increment from that number for the subsequently created items/invoice record.</li>
</ul></li>
<li>Export all data to excel file (non-essential)

<ul>
<li>Wasn&rsquo;t a requirement. I just thought it&rsquo;d be cool for local backup or accounting purposes. It&rsquo;s pretty easy to do (just writing csv to a file and downloading it).</li>
</ul></li>
<li>Store customer data (essential)

<ul>
<li>Rationale: the user doesn&rsquo;t want to keep entering customer information. Ideally users can create customers and select from existing ones everytime an invoice is created.</li>
<li>Thoughts: this is easy to do since I&rsquo;ll be duplicating existing logic for inventory list. Need to add backend endpoints to create/remove customers.</li>
</ul></li>
</ol>

<p>Those 4 features pretty much covers all the new updates for this release. This is pretty much my release notes lol. BUT I did create github tags to version the previous release since that&rsquo;s pretty much a working version too.</p>

<p>Well below are some challenges/decisions I faced implementing some of the above features.</p>

<h2 id="offline-capability">Offline capability</h2>

<p><img src="https://steven-steven.github.io/Blog/assets/images/blogAssets/building-invoice-app-v2/fsm.png" width="400" height="400" alt="Download Demo" style="margin: 1.5rem auto;"></p>

<p>I decided to make the app an offline/online hybrid. The most difficult part was being extra careful about fault tolerance making sure I cover all cases. There is essentially a replicated CRUD logic for offline mode and online mode, and the data is replicated in 3 places:
1. In the DB
    - Firebase Realtime DB
2. In the computer&rsquo;s local disk (persistent storage)
    - Electron Store
    - There are many options for persistent storage in an electron app, My main choice was <a href="" target="_blank">Electron Store</a> or <a href="" target="_blank">NEDB</a>. NEDB supports advanced queries similar to MongoDB and SQLite, while Electron Store stores data in JSON internally and is more lightweight. Thought I was going for NEDB in the beginning but the fact that it&rsquo;s no longer maintained was a bit of a turn-off and was a deal-breaker for me. Electron Store was good enough for my case. 👑
3. In Redux (in-memory storage)</p>

<p>It might seem a bit overwhelming for our state management, Redux, to listen and mediate between DB and the local storage. But all the logic is pretty much in the redux actions. Below is a sample add-Invoice logic. There are 2 cases. If it&rsquo;s offline, it adds the data to local storage + the redux state. If it&rsquo;s online, it calls the API and on success, adds the data to local storage + the redux state.</p>
<pre class="typescript"><span style="color: #fb4934">export</span> <span style="color: #fe8019">const</span> <span style="color: #fbf1c7;background-color: #282828">addInvoiceCall</span> <span style="color: #fbf1c7">=</span> <span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">newInvoice</span><span style="color: #fbf1c7">:</span> <span style="color: #fbf1c7;background-color: #282828">InvoiceRequest</span><span style="color: #fbf1c7">):</span> <span style="color: #fbf1c7;background-color: #282828">AppThunk</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7">{</span>
  <span style="color: #fb4934">return</span> <span style="color: #fb4934">async </span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26">dispatch</span><span style="color: #fbf1c7">:</span> <span style="color: #fbf1c7;background-color: #282828">AppDispatch</span><span style="color: #fbf1c7">,</span> <span style="color: #b8bb26">getState</span><span style="color: #fbf1c7">:</span> <span style="color: #fbf1c7">()</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7;background-color: #282828">RootState</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7">{</span>
    <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">setLoading</span><span style="color: #fbf1c7">());</span>
    <span style="color: #928374;font-style: italic">// Offline</span>
    <span style="color: #fb4934">if </span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7">!</span><span style="color: #fbf1c7;background-color: #282828">getState</span><span style="color: #fbf1c7">().</span><span style="color: #fbf1c7;background-color: #282828">connection</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">connected</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">{</span>
      <span style="color: #fe8019">const</span> <span style="color: #b8bb26">inv</span><span style="color: #fbf1c7">:</span> <span style="color: #fbf1c7;background-color: #282828">Invoice</span> <span style="color: #fbf1c7">=</span> <span style="color: #fbf1c7;background-color: #282828">prepareMockPostPayload</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">newInvoice</span><span style="color: #fbf1c7">);</span>
      <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">addInvoice</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">inv</span><span style="color: #fbf1c7">));</span>
      <span style="color: #fbf1c7;background-color: #282828">ipcRenderer</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">send</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">invoices_add</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">,</span> <span style="color: #fbf1c7;background-color: #282828">inv</span><span style="color: #fbf1c7">,</span> <span style="color: #d3869b">false</span><span style="color: #fbf1c7">);</span>
      <span style="color: #fb4934">return</span><span style="color: #fbf1c7">;</span>
    <span style="color: #fbf1c7">}</span>

    <span style="color: #928374;font-style: italic">// Online</span>
    <span style="color: #fb4934">try</span> <span style="color: #fbf1c7">{</span>
      <span style="color: #fe8019">const</span> <span style="color: #fbf1c7;background-color: #282828">res</span> <span style="color: #fbf1c7">=</span> <span style="color: #fb4934">await</span> <span style="color: #fbf1c7;background-color: #282828">axios</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">post</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">`</span><span style="color: #fbf1c7">${</span><span style="color: #fbf1c7;background-color: #282828">config</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">serverProxy</span><span style="color: #fbf1c7">}</span><span style="color: #b8bb26;font-style: italic">/invoice`</span><span style="color: #fbf1c7">,</span> <span style="color: #fbf1c7;background-color: #282828">newInvoice</span><span style="color: #fbf1c7">);</span>
      <span style="color: #fb4934">if </span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">data</span> <span style="color: #fbf1c7">&amp;&amp;</span> <span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">status</span> <span style="color: #fbf1c7">===</span> <span style="color: #d3869b">200</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">{</span>
        <span style="color: #fe8019">const</span> <span style="color: #fbf1c7;background-color: #282828">dateKey</span> <span style="color: #fbf1c7">=</span> <span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">data</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">Invoice</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">invoice_no</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">substring</span><span style="color: #fbf1c7">(</span><span style="color: #d3869b">0</span><span style="color: #fbf1c7">,</span> <span style="color: #d3869b">2</span><span style="color: #fbf1c7">);</span>
        <span style="color: #fe8019">const</span> <span style="color: #fbf1c7;background-color: #282828">invoiceNumber</span> <span style="color: #fbf1c7">=</span> <span style="color: #fbf1c7;background-color: #282828">parseInt</span><span style="color: #fbf1c7">(</span>
        <span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">data</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">Invoice</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">invoice_no</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">split</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">-</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">)[</span><span style="color: #d3869b">1</span><span style="color: #fbf1c7">],</span><span style="color: #d3869b">10</span><span style="color: #fbf1c7">);</span>
        <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">addInvoice</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">data</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">Invoice</span><span style="color: #fbf1c7">));</span>
        <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">setInvoiceNumber</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">dateKey</span><span style="color: #fbf1c7">,</span> <span style="color: #fbf1c7;background-color: #282828">invoiceNumber</span> <span style="color: #fbf1c7">+</span> <span style="color: #d3869b">1</span><span style="color: #fbf1c7">));</span>
        <span style="color: #fbf1c7;background-color: #282828">ipcRenderer</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">send</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">invoices_add</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">,</span> <span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">data</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">Invoice</span><span style="color: #fbf1c7">,</span> <span style="color: #d3869b">true</span><span style="color: #fbf1c7">);</span>
      <span style="color: #fbf1c7">}</span> <span style="color: #fb4934">else</span> <span style="color: #fbf1c7">{</span>
        <span style="color: #fb4934">throw</span> <span style="color: #fb4934">new</span> <span style="color: #8ec07c">Error</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">`</span><span style="color: #fbf1c7">${</span><span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">status</span><span style="color: #fbf1c7">}</span><span style="color: #b8bb26;font-style: italic">: </span><span style="color: #fbf1c7">${</span><span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">}</span><span style="color: #b8bb26;font-style: italic">`</span><span style="color: #fbf1c7">);</span>
      <span style="color: #fbf1c7">}</span>
    <span style="color: #fbf1c7">}</span> <span style="color: #fb4934">catch </span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">e</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">{</span>
      <span style="color: #fbf1c7;background-color: #282828">ipcRenderer</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">send</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">showError</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">,</span> <span style="color: #b8bb26;font-style: italic">`Gagal membuat invoice baru: </span><span style="color: #fbf1c7">${</span><span style="color: #fbf1c7;background-color: #282828">e</span><span style="color: #fbf1c7">}</span><span style="color: #b8bb26;font-style: italic">`</span><span style="color: #fbf1c7">);</span>
      <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">setIdle</span><span style="color: #fbf1c7">());</span>
    <span style="color: #fbf1c7">}</span>
  <span style="color: #fbf1c7">};</span>
<span style="color: #fbf1c7">};</span>
</pre>
<p>Another challenging part would then be to sync the local data to the cloud once an online connection is detected.</p>

<p>I think there are 4 cases to take into account:
- First load and is offline (I fetch initial data from local storage)
- First load and is online (sync offline data and fetch data from the cloud)
- Going from offline to online (sync offline data and fetch data from the cloud)
- Going from online to offline (nothing. We assume redux and local storage is up-to-date)</p>

<p>This logic is implemented in the code snippet below.</p>
<pre class="typescript"><span style="color: #fb4934;background-color: #282828;font-weight: bold">…</span>
<span style="color: #fb4934">export</span> <span style="color: #fe8019">const</span> <span style="color: #fbf1c7;background-color: #282828">startListening</span> <span style="color: #fbf1c7">=</span> <span style="color: #fbf1c7">():</span> <span style="color: #fbf1c7;background-color: #282828">AppThunk</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7">{</span>
  <span style="color: #fb4934">return </span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26">dispatch</span><span style="color: #fbf1c7">:</span> <span style="color: #fb4934">any</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7">{</span>
    <span style="color: #fbf1c7;background-color: #282828">database</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">ref</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">.info/connected</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">).</span><span style="color: #fbf1c7;background-color: #282828">on</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">value</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">,</span> <span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">snap</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7">{</span>
      <span style="color: #fb4934">if </span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">snap</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">val</span><span style="color: #fbf1c7">()</span> <span style="color: #fbf1c7">===</span> <span style="color: #d3869b">true</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">{</span>
        <span style="color: #928374;font-style: italic">// sync dirty cache when it comes back up</span>
        <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">syncInvoices</span><span style="color: #fbf1c7">());</span>
        <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">syncItems</span><span style="color: #fbf1c7">());</span>
        <span style="color: #928374;font-style: italic">// Internet Connected</span>
        <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">setConnected</span><span style="color: #fbf1c7">());</span>
        <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">startListeningInvoices</span><span style="color: #fbf1c7">());</span>
        <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">startListeningItems</span><span style="color: #fbf1c7">());</span>
      <span style="color: #fbf1c7">}</span> <span style="color: #fb4934">else</span> <span style="color: #fbf1c7">{</span>
        <span style="color: #928374;font-style: italic">// Internet Disconnected</span>
        <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">setDisconnected</span><span style="color: #fbf1c7">());</span>
        <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">stopListeningInvoices</span><span style="color: #fbf1c7">());</span>
        <span style="color: #fbf1c7;background-color: #282828">dispatch</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">stopListeningItems</span><span style="color: #fbf1c7">());</span>
      <span style="color: #fbf1c7">}</span>
    <span style="color: #fbf1c7">});</span>
  <span style="color: #fbf1c7">};</span>
<span style="color: #fbf1c7">};</span>
<span style="color: #fb4934">export</span> <span style="color: #fe8019">const</span> <span style="color: #fbf1c7;background-color: #282828">getIsConnected</span> <span style="color: #fbf1c7">=</span> <span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">state</span><span style="color: #fbf1c7">:</span> <span style="color: #fbf1c7;background-color: #282828">RootState</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7;background-color: #282828">state</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">connection</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">connected</span><span style="color: #fbf1c7">;</span>
</pre>
<p>And yes, every data stored in the local storage has an extra metadata like &lsquo;markedToDelete&rsquo; and &lsquo;isSaved&rsquo; as a flag so during the sync process I can identify which data is dirty (ie. Which data needs to be deleted, added, or updated in the Cloud DB). Here is what the syncing looks like:</p>
<pre class="typescript"><span style="color: #928374;font-style: italic">/*
* Clean up dirty (added/updated/deleted) data in local electron-store
*/</span>
<span style="color: #fb4934">export</span> <span style="color: #fe8019">const</span> <span style="color: #fbf1c7;background-color: #282828">syncDirtyData</span> <span style="color: #fbf1c7">=</span> <span style="color: #fbf1c7">():</span> <span style="color: #fbf1c7;background-color: #282828">AppThunk</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7">{</span>
  <span style="color: #fb4934">return</span> <span style="color: #fb4934">async </span><span style="color: #fbf1c7">()</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7">{</span>
    <span style="color: #928374;font-style: italic">// check if synced</span>
    <span style="color: #fe8019">const</span> <span style="color: #fbf1c7;background-color: #282828">isSynced</span> <span style="color: #fbf1c7">=</span> <span style="color: #fb4934">await</span> <span style="color: #fbf1c7;background-color: #282828">ipcRenderer</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">invoke</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">invoices_getIsSynced</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">);</span>
    <span style="color: #fb4934">if </span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">isSynced</span><span style="color: #fbf1c7">)</span> <span style="color: #fb4934">return</span><span style="color: #fbf1c7">;</span>
    <span style="color: #928374;font-style: italic">// pull unsynced changes to delete/add</span>
    <span style="color: #fe8019">const</span> <span style="color: #fbf1c7">{</span> <span style="color: #fbf1c7;background-color: #282828">toDelete</span><span style="color: #fbf1c7">,</span> <span style="color: #fbf1c7;background-color: #282828">toAdd</span> <span style="color: #fbf1c7">}:</span> <span style="color: #fbf1c7;background-color: #282828">UnsavedChanges</span> <span style="color: #fbf1c7">=</span> <span style="color: #fb4934">await</span> <span style="color: #fbf1c7;background-color: #282828">ipcRenderer</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">invoke</span><span style="color: #fbf1c7">(</span>
      <span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">invoices_getUnsavedChanges</span><span style="color: #b8bb26;font-style: italic">'</span>
    <span style="color: #fbf1c7">);</span>
    <span style="color: #928374;font-style: italic">// try to delete all the marked invoices</span>
    <span style="color: #fb4934">try</span> <span style="color: #fbf1c7">{</span>
      <span style="color: #fb4934">await</span> <span style="color: #fbf1c7;background-color: #282828">Promise</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">all</span><span style="color: #fbf1c7">(</span>
        <span style="color: #fbf1c7;background-color: #282828">toDelete</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">map</span><span style="color: #fbf1c7">(</span><span style="color: #fb4934">async </span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">id</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7">{</span>
          <span style="color: #fe8019">const</span> <span style="color: #fbf1c7">{</span> <span style="color: #fbf1c7;background-color: #282828">data</span> <span style="color: #fbf1c7">}</span> <span style="color: #fbf1c7">=</span> <span style="color: #fb4934">await</span> <span style="color: #fbf1c7;background-color: #282828">axios</span><span style="color: #fbf1c7">.</span><span style="color: #fb4934">delete</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">`</span><span style="color: #fbf1c7">${</span><span style="color: #fbf1c7;background-color: #282828">config</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">serverProxy</span><span style="color: #fbf1c7">}</span><span style="color: #b8bb26;font-style: italic">/invoice/</span><span style="color: #fbf1c7">${</span><span style="color: #fbf1c7;background-color: #282828">id</span><span style="color: #fbf1c7">}</span><span style="color: #b8bb26;font-style: italic">`</span><span style="color: #fbf1c7">);</span>
          <span style="color: #fb4934">if </span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">data</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">Success</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">{</span>
            <span style="color: #fbf1c7;background-color: #282828">ipcRenderer</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">send</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">invoices_delete</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">,</span> <span style="color: #fbf1c7;background-color: #282828">id</span><span style="color: #fbf1c7">,</span> <span style="color: #d3869b">true</span><span style="color: #fbf1c7">);</span>
          <span style="color: #fbf1c7">}</span>
        <span style="color: #fbf1c7">})</span>
      <span style="color: #fbf1c7">);</span>
    <span style="color: #fbf1c7">}</span> <span style="color: #fb4934">catch </span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">e</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">{</span>
      <span style="color: #fbf1c7;background-color: #282828">ipcRenderer</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">send</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">showError</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">,</span> <span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">Syncing Error! (delete)</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">);</span>
    <span style="color: #fbf1c7">}</span>
    <span style="color: #928374;font-style: italic">// try to add all the marked invoices</span>
    <span style="color: #fb4934">try</span> <span style="color: #fbf1c7">{</span>
      <span style="color: #fb4934">await</span> <span style="color: #fbf1c7;background-color: #282828">Promise</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">all</span><span style="color: #fbf1c7">(</span>
        <span style="color: #fbf1c7;background-color: #282828">toAdd</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">map</span><span style="color: #fbf1c7">(</span><span style="color: #fb4934">async </span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26">invoice</span><span style="color: #fbf1c7">:</span> <span style="color: #fbf1c7;background-color: #282828">Invoice</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">=&gt;</span> <span style="color: #fbf1c7">{</span>
          <span style="color: #fe8019">const</span> <span style="color: #fbf1c7;background-color: #282828">res</span> <span style="color: #fbf1c7">=</span> <span style="color: #fb4934">await</span> <span style="color: #fbf1c7;background-color: #282828">axios</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">put</span><span style="color: #fbf1c7">(</span>
            <span style="color: #b8bb26;font-style: italic">`</span><span style="color: #fbf1c7">${</span><span style="color: #fbf1c7;background-color: #282828">config</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">serverProxy</span><span style="color: #fbf1c7">}</span><span style="color: #b8bb26;font-style: italic">/invoice/</span><span style="color: #fbf1c7">${</span><span style="color: #fbf1c7;background-color: #282828">invoice</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">id</span><span style="color: #fbf1c7">}</span><span style="color: #b8bb26;font-style: italic">`</span><span style="color: #fbf1c7">,</span>
            <span style="color: #fbf1c7;background-color: #282828">invoice</span>
          <span style="color: #fbf1c7">);</span>
          <span style="color: #fb4934">if </span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">data</span> <span style="color: #fbf1c7">&amp;&amp;</span> <span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">status</span> <span style="color: #fbf1c7">===</span> <span style="color: #d3869b">200</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">{</span>
            <span style="color: #fbf1c7;background-color: #282828">ipcRenderer</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">send</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">invoices_add</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">,</span> <span style="color: #fbf1c7;background-color: #282828">res</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">data</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">Invoice</span><span style="color: #fbf1c7">,</span> <span style="color: #d3869b">true</span><span style="color: #fbf1c7">);</span>
          <span style="color: #fbf1c7">}</span>
        <span style="color: #fbf1c7">})</span>
      <span style="color: #fbf1c7">);</span>
    <span style="color: #fbf1c7">}</span> <span style="color: #fb4934">catch </span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">e</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">{</span>
      <span style="color: #fbf1c7;background-color: #282828">ipcRenderer</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">send</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">showError</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">,</span> <span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">Syncing Error! (put)</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">);</span>
    <span style="color: #fbf1c7">}</span>
    <span style="color: #928374;font-style: italic">// set synced</span>
    <span style="color: #fbf1c7;background-color: #282828">ipcRenderer</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">send</span><span style="color: #fbf1c7">(</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #b8bb26;font-style: italic">invoices_setSynced</span><span style="color: #b8bb26;font-style: italic">'</span><span style="color: #fbf1c7">);</span>
  <span style="color: #fbf1c7">};</span>
<span style="color: #fbf1c7">};</span>
</pre>
<p>Overall it does seem like a bit of an overkill to write the data on multiple places every time. But I can&rsquo;t think of a better solution since replication is inevitable to maintain fault tolerance.</p>

<h2 id="mocking-a-utility-function-in-go-test">Mocking a utility function in Go Test</h2>

<p>Generating uuid in the server is straight-forward. But I had some troubles mocking it for testing. Say I test the POST /invoice service. I somehow need to know deterministically what the output of the service call is (including the generated UUID!). Since that&rsquo;s impossible, the only way is to mock that utility.
As I mentioned in a few of my earlier posts, I&rsquo;m pretty new to Golang so figuring this out took a while…
A possible solution is using a mocking framework like <a href="" target="_blank">testify/mock</a>. Seems I can only mock the entire service object (can&rsquo;t just mock a function). On top of that, the function is an externally imported package! I&rsquo;m sure I can somehow wrap the generateUUID() as it&rsquo;s own service or something, but it seems like a complete overkill…</p>

<p>Then I came across a very painlessly pretty method ✨ without any library. Probably one of my favorite Go code.
[<a href="https://stackoverflow.com/questions/42952191/is-it-possible-to-mock-a-function-imported-from-a-package-in-golang" target="_blank">Source1</a>] [<a href="https://stackoverflow.com/questions/51428617/how-do-i-mock-a-function-from-another-package-without-using-dependency-injection" target="_blank">Source2</a>]</p>

<p>Basically, I can define the utility function (generateUUID()) as a global variable. Since in Go, the scope is shared through the entire package, I can access this global variable that our service is referring to from the test file. Now when running the test, we manually replace this global variable with a mock (one that returns a deterministic id). Once we&rsquo;re done with the test, we simply put the original variable back. So it&rsquo;s like we &lsquo;borrow&rsquo; the global variable to do what we want for the span of our test. That&rsquo;s smart!
Yay! Another piece of skill to add to my repertoire of Go best practices! Now I can run around flexing with this piece of code:</p>
<pre class="go"><span style="color: #928374;font-style: italic">/* service.go */</span>
<span style="color: #fb4934;background-color: #282828;font-weight: bold">…</span>
<span style="color: #fb4934">var</span> <span style="color: #fbf1c7;background-color: #282828">idGenerator</span> <span style="color: #fbf1c7">=</span> <span style="color: #fbf1c7;background-color: #282828">utils</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">GenerateUUID</span>
<span style="color: #fb4934;background-color: #282828;font-weight: bold">…</span>

</pre><pre class="go"><span style="color: #928374;font-style: italic">/* service_test.go */</span>
<span style="color: #fb4934;background-color: #282828;font-weight: bold">…</span>
<span style="color: #fb4934">func</span> <span style="color: #fbf1c7;background-color: #282828">mock_defer_idGenerator</span><span style="color: #fbf1c7">()</span> <span style="color: #fb4934">func</span><span style="color: #fbf1c7">()</span> <span style="color: #fbf1c7">{</span>
    <span style="color: #928374;font-style: italic">// mock idGenerator() to return id1.</span>
    <span style="color: #fbf1c7;background-color: #282828">origIdGenerator</span> <span style="color: #fbf1c7">:=</span> <span style="color: #fbf1c7;background-color: #282828">idGenerator</span>
    <span style="color: #fbf1c7;background-color: #282828">num</span> <span style="color: #fbf1c7">:=</span> <span style="color: #d3869b">0</span>
    <span style="color: #fbf1c7;background-color: #282828">idGenerator</span> <span style="color: #fbf1c7">=</span> <span style="color: #fb4934">func</span><span style="color: #fbf1c7">()</span> <span style="color: #fabd2f">string</span> <span style="color: #fbf1c7">{</span>
        <span style="color: #fbf1c7;background-color: #282828">num</span> <span style="color: #fbf1c7">+=</span> <span style="color: #d3869b">1</span>
        <span style="color: #fb4934">return</span> <span style="color: #b8bb26;font-style: italic">"item_"</span> <span style="color: #fbf1c7">+</span> <span style="color: #fbf1c7;background-color: #282828">strconv</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">Itoa</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">num</span><span style="color: #fbf1c7">)</span>
    <span style="color: #fbf1c7">}</span>
    <span style="color: #fb4934">return</span> <span style="color: #fb4934">func</span><span style="color: #fbf1c7">()</span> <span style="color: #fbf1c7">{</span> <span style="color: #fbf1c7;background-color: #282828">idGenerator</span> <span style="color: #fbf1c7">=</span> <span style="color: #fbf1c7;background-color: #282828">origIdGenerator</span> <span style="color: #fbf1c7">}</span>
<span style="color: #fbf1c7">}</span>
<span style="color: #fb4934;background-color: #282828;font-weight: bold">…</span>
<span style="color: #fb4934">func</span> <span style="color: #fbf1c7;background-color: #282828">TestGetInvoice</span><span style="color: #fbf1c7">(</span><span style="color: #fbf1c7;background-color: #282828">t</span> <span style="color: #fbf1c7">*</span><span style="color: #fbf1c7;background-color: #282828">testing</span><span style="color: #fbf1c7">.</span><span style="color: #fbf1c7;background-color: #282828">T</span><span style="color: #fbf1c7">)</span> <span style="color: #fbf1c7">{</span>
    <span style="color: #fb4934">defer</span> <span style="color: #fbf1c7;background-color: #282828">mock_defer_idGenerator</span><span style="color: #fbf1c7">()()</span>
    <span style="color: #fb4934;background-color: #282828;font-weight: bold">…</span><span style="color: #fbf1c7">.</span>
<span style="color: #fbf1c7">}</span>
<span style="color: #fb4934;background-color: #282828;font-weight: bold">…</span>
</pre>
<p>As shown above, in the &lsquo;mock<em>defer</em>idGenerator()&rsquo;, I first temporarily keep the original global variable. Then I replace it with my own utility function, which uses a closure to return a unique id every time its called (&lsquo;item<em>1&rsquo;, &lsquo;item</em>2&rsquo;, …). Finally I return a function to defer that basically returns the borrowed global variable to its original owner at the end of our test.</p>

<h2 id="typescript">Typescript</h2>

<p>Just a quick shoutout to a typescript error that keeps me up late at night once. It was related to &lsquo;redux-toolkit&rsquo;, and the solution was that it requires me to define my array of middleware in a certain order. <a href="https://github.com/reduxjs/redux-toolkit/issues/368" target="_blank">Source</a></p>

<p>I despise long typescript errors that doesn&rsquo;t give a good context. But hopefully I get better at identifying these types of errors more quickly next time.. I think Typescript is certainly one of the things I want to formally learn in the future. It&rsquo;s super cool and useful but some stuff seems a bit of a mystery at times.</p>

<h2 id="thats-it">That&rsquo;s it!</h2>

<p>Since I already briefly talk about closure (pun intended), I don&rsquo;t think there&rsquo;s a need for me to write a proper closure for this post. Peace ✌️</p>

<p>Feel free to check the code.
https://github.com/steven-steven/GoInvoice
https://github.com/steven-steven/electroninvoice</p>

<p>Some gifs below as a quick demo. Yes.. gif with a hard G. Like &lsquo;Graphic&rsquo; type of G. Not Jif. Jif bad ☹. Gif good🙂.</p>

<p>editing offline, and syncing back when online:
<img src="https://steven-steven.github.io/Blog/assets/images/blogAssets/building-invoice-app-v2/offline.gif" width="400" height="400" alt="Download Demo" style="margin: 1.5rem auto;">
adding/editing customers:
<img src="https://steven-steven.github.io/Blog/assets/images/blogAssets/building-invoice-app-v2/customerList.gif" width="400" height="400" alt="Download Demo" style="margin: 1.5rem auto;"></p>

  </main>
  <div class="my-10">
    <button id="js-discuss-button" class="rounded-2xl border-2 border-slate-400 md:w-auto w-full px-5 py-4 hover:font-semibold">Show comments</button>
<div id="disqus_thread"></div>
<script>
  var commentButton = document.getElementById("js-discuss-button")
  var disqus_config = function () {
    this.page.url = `https://stevenwhat.me/blog/building-invoice-app-v2`;
    this.page.identifier = "/blog/building_invoice_app_v2";
    this.page.title = "Building Invoice App V2";
  };
  commentButton.addEventListener('click', function() {
    var d = document, s = d.createElement('script');
    s.src = 'https://blog-zlm7tpahgt.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);

    event.target.parentElement.removeChild(event.target);
  })
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  </div>

    </div>
    <div data-controller="subscription" class="flex flex-col items-center p-8 bg-slate-50 dark:bg-slate-800 dark:shadow-slate-700 shadow-lg">
  <p class="text-xl">Get my latest articles and updates</p>
  <p>At most one email a month and no spam.</p>

  <div class="mt-5 flex">
    <label class="items-center">
      <input type="email" data-subscription-target="email" class="w-full rounded-xl dark:bg-zinc-700" placeholder="Your email" required>
    </label>
    <button type="submit" data-action="click->subscription#submitForm" class="px-3 ml-2 ext-white bg-blue-500 rounded-lg">
      Subscribe
    </button>
  </div>
</div>

    <footer class="">
      <div class="text-center text-xs">© Steven 2019</div>
    </footer>
  </div>

  </body>
</html>
